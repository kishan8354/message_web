<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Display System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f1929;
            --bg-secondary: #192845;
            --bg-panel: #1a2b41;
            --accent: #4696dc;
            --text-primary: #dcf0ff;
            --text-secondary: #b4c8e6;
            --success: #32c878;
            --warning: #ffb43c;
            --error: #ff6464;
            --border: #233759;
            --hover: #5aaafd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-panel);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--accent);
            box-shadow: 0 8px 32px rgba(70, 150, 220, 0.1);
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            text-align: center;
            background: linear-gradient(45deg, var(--accent), var(--hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: var(--accent);
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--accent);
        }

        .btn:hover {
            background: var(--hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(70, 150, 220, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .message-list {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 2px solid var(--accent);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .message-content {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 2px solid var(--accent);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: var(--accent);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 18px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .message-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .message-item:hover {
            background: rgba(70, 150, 220, 0.1);
        }

        .message-item.selected {
            background: rgba(70, 150, 220, 0.2);
            border-left: 4px solid var(--accent);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 16px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-subject {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .message-preview {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-indicators {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-read { background: var(--success); }
        .status-unread { background: var(--warning); }
        .priority-high { background: var(--warning); }
        .priority-critical { background: var(--error); }
        .priority-medium { background: var(--success); }

        .content-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .content-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .content-field {
            margin-bottom: 15px;
        }

        .content-label {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .content-value {
            color: var(--text-secondary);
        }

        .message-body {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .code-container {
            position: relative;
            margin: 15px 0;
        }

        .code-header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        pre {
            margin: 0 !important;
            border-radius: 0 0 8px 8px !important;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .text-content {
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 15px;
            color: var(--text-secondary);
        }

        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 18px;
            text-align: center;
        }

        .status-bar {
            background: var(--bg-panel);
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .status-text {
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .error {
            color: var(--error);
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .controls {
                justify-content: stretch;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
            
            .message-content {
                margin-top: 20px;
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Message Display System</h1>
            <div class="controls">
                <button class="btn" onclick="refreshMessages()">🔄 Refresh</button>
                <button class="btn" onclick="toggleFilter()">🔍 Filter</button>
                <button class="btn" onclick="markAllRead()">✓ Mark All Read</button>
                <button class="btn" onclick="composeMessage()">✏️ Compose</button>
            </div>
        </div>

        <div class="main-content">
            <div class="message-list">
                <div class="panel-header">Message Inbox (<span id="message-count">0</span>)</div>
                <div class="messages-container" id="messagesList">
                    <div class="loading">Loading messages...</div>
                </div>
            </div>

            <div class="message-content">
                <div class="panel-header">Message Content</div>
                <div class="content-container" id="messageContent">
                    <div class="placeholder">
                        Select a message to view its content
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-text" id="statusText">System Status: Connecting to backend...</div>
            <div class="status-indicator" id="statusIndicator"></div>
        </div>
    </div>

    <script>
        class MessageSystem {
            constructor() {
                this.apiKey = 'X7kP9mW3qT2rY8nF4vJ6hL5zB1cD';
                // TODO: Update this URL to match your backend API endpoint
                this.apiBaseUrl = window.location.origin + '/messages'; // e.g., 'https://your-backend.com/api/messages'
                this.messages = [];
                this.selectedMessage = null;
                this.refreshInterval = null;
                this.init();
            }

            async init() {
                console.log('Initializing message system...');
                await this.loadMessages();
                this.startAutoRefresh();
                this.updateStatus('All services operational', 'success');
            }

            async loadMessages() {
                console.log('Loading messages...');
                try {
                    const response = await this.getAPIMessages();
                    if (response && Array.isArray(response)) {
                        this.messages = response;
                        console.log('Messages loaded:', this.messages);
                        this.renderMessages();
                        this.updateStatus(`Loaded ${this.messages.length} messages`, 'success');
                    } else {
                        throw new Error('Invalid API response format: Expected an array');
                    }
                } catch (error) {
                    console.error('Failed to load messages:', error.message);
                    // Use fallback data if API fails
                    this.messages = this.getFallbackMessages();
                    console.log('Using fallback messages:', this.messages);
                    this.renderMessages();
                    this.updateStatus(`Failed to load messages from API: ${error.message}. Using fallback data.`, 'error');
                }
            }

            async getAPIMessages() {
                try {
                    console.log('Fetching messages from:', this.apiBaseUrl);
                    const response = await fetch(this.apiBaseUrl, {
                        method: 'GET',
                        headers: {
                            // Adjust authentication method based on backend requirements
                            // e.g., 'X-API-Key': this.apiKey for API key in header
                            // or append to URL: `${this.apiBaseUrl}?apiKey=${this.apiKey}`
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('API response:', data);

                    // Validate response structure
                    if (!Array.isArray(data)) {
                        throw new Error('API response is not an array');
                    }

                    // Map messages to ensure required fields
                    return data.map(message => ({
                        id: message.id || Math.random().toString(36).substr(2, 9),
                        sender: message.sender || 'Unknown',
                        email: message.email || 'no-email',
                        subject: message.subject || 'No Subject',
                        content: message.content || '',
                        timestamp: message.timestamp || new Date().toISOString(),
                        status: message.status || 'unread',
                        priority: message.priority || 'medium',
                        type: message.type || 'text',
                        language: message.language || 'text'
                    }));
                } catch (error) {
                    console.error('Error fetching messages from API:', error);
                    throw error;
                }
            }

            getFallbackMessages() {
                // Fallback data from logs
                return [
                    {
                        id: 'msg1',
                        sender: 'PythonScript',
                        email: 'ai@python.org',
                        subject: 'Log Extract 1',
                        content: '📝 Extracted Text:\n\n' +
                            'f screenshot_20... U 1327 SCREENSHOTS_DIR = “screenshots”\n' +
                            'fa screenshot_20... U 1328\n' +
                            'screenshot 20... U 1329 - Create Baqecnstees directory if it doesn\'t exist\n' +
                            'rn neem, 0 1330 if not os.path.exists(SCREENSHOTS_DIR):\n' +
                            '\\ screensnot_20... 1331 os.makedirs(SCREENSHOTS_DIR)\n' +
                            '"& screenshot_20... U -\n' +
                            '> venv PROBLEMS OUTPUT DEBUGCONSOLE TERMINAL = PORTS_-~— POLYGLOT NOTEBOOK python Tv We A x\n' +
                            '© app.py M .99- se\n' +
                            '_ . 2025-@6-@2 17:22:45,152 - INFO - Service interrupted by user\n' +
                            'E hotkey_service.log U 2025-@6-@2 17:22:45,153 - INFO - Hotkey Service stopped\n' +
                            '<> index.html U PS C:\\Users\\kk382\\OneDrive\\Desktop\\helping in exam> python app.py\n' +
                            '= integrated _scree... U 2025-@6-@2 17:33:39,005 - INFO - Hotkey Service initialized\n' +
                            '= interview assista.. U 2025-@6-02 39,086 - INFO - Starting Hotkey Service...\n' +
                            '_ . a ~ 2@25-@6-@2 17:33:39,157 - INFO - Registered hotkey: Ctr1+Alt+T for screenshot + AI solution\n' +
                            '@ interview_assista... U 2025-26-02 99,157 - INFO - Registered hotkey: Ctr1+Alt+E for screenshot + text extraction\n' +
                            '= message_monit... U 2025-@6-@2 17:33:39,158 - INFO - Hotkey Service is running...\n' +
                            '® quick test script... U 2025-06-02 99,158 - INFO - Press Ctr1+Alt+T for screenshot + AI solution .\n' +
                            '> 2025-06-02 139,158 - INFO - Press Ctr1+Alt+E for screenshot + text extraction\n' +
                            'syste Guu 2025-26-02 9,158 - INFO - Press Ctrl+C to exit\n' +
                            '> TIMELINE | .\n' +
                            "xX $9 main* G [> RunTestcases @0A\\0 © Not Committed Yet Ln 1329,Col49 Spaces:4 UTF-8 LF {} Python € 3.13.0(‘venv':venv)\n" +
                            '17:33\n' +
                            'om\n' +
                            '* D) 99-06-2025\n' +
                            'IN',
                        type: 'code',
                        language: 'text',
                        timestamp: '2025-06-02T17:33:45.777695',
                        status: 'unread',
                        priority: 'medium'
                    },
                    {
                        id: 'msg2',
                        sender: 'PythonScript',
                        email: 'ai@python.org',
                        subject: 'Log Extract 2',
                        content: '📝 Extracted Text:\n\n' +
                            'v Deeps X | % Claud xX | © Twos X | & Cand X | GF Mess X we mess X wf Mess X | Mess X | @ Intro: X | @ Reali xX | + - [a] x\n' +
                            '€ Cc 23 dashboard.render.com/web/srv-d0kdc7 56ubrc73b73fn0/deploys/dep-d0up5gre5dus73a0502g RQ vx fo] > 2\n' +
                            'f M MyWorkspace ¢ ® message_web-4 v Q Search »K + New % Upgrade @ ©\n' +
                            'Alllogs v Q_ Search D Livetail » | GMT+5:30\n' +
                            '@ message_web-4\n' +
                            'Jun 2 05:33:44 PM @ ‘a interview_assista... U 2025-26-02 99,157 - INFO - Registered hotkey: Ctri+Alt+E for s\n' +
                            'creenshot + text extraction\n' +
                            'Settings Jun 2 05:33:44 PM @ ‘\n' +
                            'Jun 2 05:33:44 PM @ ‘= message_monit... U 2025-a6-a2 17:33:39,158 - INFO - Hotkey Service is running...\n' +
                            'Jun 2 05:33:44 PM @ ‘\n' +
                            'Jun 2 05:33:44 PM @ "® quick test script... U 2025-06-02 99,158 - INFO - Press Ctri+Alt+T for screenshot + A\n' +
                            'Logs I solution .\n' +
                            'Jun 2 05:33:44 PM\n' +
                            'Metrics Jun 2 05:33:44 PM\n' +
                            'Jun 2 05:33:44 PM\n' +
                            '> 2025-06-02 139,158 - INFO - Press Ctri+Alt+E for screenshot + text extraction\n' +
                            'syste Guu 2025-26-02 9,158 - INFO - Press Ctrl+C to exit\n' +
                            'Jun 2 05:33:44 PM “> TIMELINE | .\n' +
                            '"xX $9 main* G [> RunTestcases @0A\\\\0 © Not\n' +
                            '€ 3.13.0(‘venv\':venv)\n' +
                            '&] Changelog v Jun 2 05:33:44 PM @ ‘\nt 4\n' +
                            'Jun 2 05:33:44 PM @ "17:33\n' +
                            '{J Invite a friend un ne\n' +
                            'Jun 2 05:33:44 PM @ "\n' +
                            'C7 Contact support\n' +
                            'Jun 2 05:33:44 PM @ ‘om\n' +
                            'v‘ Render Status Need better ways to work with logs? Try the orsetupa\n' +
                            ') ENG -zAY 17:34\n' +
                            '6 Qu BOR & ¢ | ~ > g ¢€ ~ in ® DY ® 206-2025',
                        type: 'code',
                        language: 'text',
                        timestamp: '2025-06-02T17:34:08.226096',
                        status: 'unread',
                        priority: 'medium'
                    },
                    {
                        id: 'msg3',
                        sender: 'PythonScript',
                        email: 'ai@python.org',
                        subject: 'Log Extract 3',
                        content: '📝 Extracted Text:\n\n' +
                            'v Deep: X\n' +
                            'o-\n' +
                            'So\n' +
                            '€ Cc\n' +
                            'e\n' +
                            '@ message_web-4\n' +
                            'Settings\n' +
                            'Logs\n' +
                            'Metrics\n' +
                            'tt\n' +
                            'Changelog\n' +
                            '{J Invite a friend\n' +
                            '7 Contact support\n' +
                            'Render Status\n' +
                            'e\n' +
                            '% Claud x\n' +
                            'M MyWorkspace ¢\n' +
                            '€ twos X\n' +
                            '© Cand\n' +
                            'x\n' +
                            'Alllogs v\n' +
                            'Jun 2 05:33:\n' +
                            'Jun 2 05:33:\n' +
                            'F {} Python\n' +
                            'Jun 2 05:33\n' +
                            'Jun 2 05:33\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'v Jun\n' +
                            'Jun\n' +
                            'Jun\n' +
                            'QuB?OUGCE\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '2\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '05:\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            '33\n' +
                            ':44 PM @\n' +
                            ':44 PM\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '744\n' +
                            '750\n' +
                            '754\n' +
                            'SS Mess X we mess: X wf Mess X | g Mess: X\n' +
                            'dashboard.render.com/web/srv-dO0kdc756ubrc73b73fn0/deploys/dep-d0up5gre5dus73a0502g\n' +
                            '@® message_web-4 v\n' +
                            'Q. Search\n' +
                            '44 PM @ "> TIMELINE | .\n' +
                            '44 PM @ "xX $9 main* G [> RunTestcases @0A\\\\0 © Not\n' +
                            '€ 3.13.0(‘venv\':venv)\n' +
                            '"\n' +
                            '"17:33\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            'PM\n' +
                            '"\n' +
                            '"om\n' +
                            '"* D) 99-06-2025\n' +
                            '"\n' +
                            '"IN',
                        type: 'code',
                        language: 'text',
                        timestamp: '2025-06-02T17:34:20.740927',
                        status: 'unread',
                        priority: 'medium'
                    },
                    {
                        id: 'msg4',
                        sender: 'PythonScript',
                        email: 'ai@python.org',
                        subject: 'Candy Distribution Solution',
                        content: '🤖 AI Solution:\n\n' +
                            '```cpp\n' +
                            '#include <iostream>\n' +
                            '#include <vector>\n' +
                            '\n' +
                            'using namespace std;\n' +
                            '\n' +
                            '/*\n' +
                            'Approach:\n' +
                            '\n' +
                            'This solution uses a two-pass approach to efficiently calculate the minimum candies needed.\n' +
                            '\n' +
                            '1. First Pass (Left to Right):\n' +
                            "   - Initialize a vector 'ans' with all 1s (each child gets at least one candy).\n" +
                            "   - Iterate through the 'ratings' vector from left to right.\n" +
                            "   - If the current child's rating is higher than the previous child's rating, the current child gets one more candy than the previous child (ans[i] += ans[i-1]).\n" +
                            '\n' +
                            '2. Second Pass (Right to Left):\n' +
                            "   - Iterate through the 'ratings' vector from right to left.\n" +
                            "   - If the current child's rating is higher than the next child's rating, and the current child has fewer candies than the next child, update the current child's candy count to be one more than the next child's (ans[i] = max(ans[i], ans[i+1] + 1)).\n" +
                            '\n' +
                            '3. Summation:\n' +
                            "   - Finally, sum up all the candy counts in the 'ans' vector to get the total minimum candies needed.\n" +
                            '\n' +
                            '*/\n' +
                            '\n' +
                            'class Solution {\n' +
                            'public:\n' +
                            '    int candy(vector<int>& ratings) {\n' +
                            '        int n = ratings.size();\n' +
                            '        if (n == 0) return 0; // Handle empty input\n' +
                            '        vector<int> ans(n, 1); // Initialize each child with 1 candy\n' +
                            '\n' +
                            '        // First pass (left to right)\n' +
                            '        for (int i = 1; i < n; ++i) {\n' +
                            '            if (ratings[i] > ratings[i - 1]) {\n' +
                            '                ans[i] = ans[i - 1] + 1;\n' +
                            '            }\n' +
                            '        }\n' +
                            '\n' +
                            '        // Second pass (right to left)\n' +
                            '        for (int i = n - 2; i >= 0; --i) {\n' +
                            '            if (ratings[i] > ratings[i + 1]) {\n' +
                            '                ans[i] = max(ans[i], ans[i + 1] + 1);\n' +
                            '            }\n' +
                            '        }\n' +
                            '\n' +
                            '        // Sum up the candies\n' +
                            '        int totalCandies = 0;\n' +
                            '        for (int count : ans) {\n' +
                            '            totalCandies += count;\n' +
                            '        }\n' +
                            '        return totalCandies;\n' +
                            '    }\n' +
                            '};\n' +
                            '\n' +
                            'int main() {\n' +
                            '    Solution sol;\n' +
                            '    vector<int> ratings1 = {1, 0, 2};\n' +
                            '    cout << "Minimum candies for ratings " << "[1,0,2]" << ": " << sol.candy(ratings1) << endl; // Output: 5\n' +
                            '    vector<int> ratings2 = {1,2,2};\n' +
                            '    cout << "Minimum candies for ratings " << "[1,2,2]" << ": " << sol.candy(ratings2) << endl; // Output: 4\n' +
                            '    vector<int> ratings3 = {};\n' +
                            '    cout << "Minimum candies for ratings " << "[]" << ": " << sol.candy(ratings3) << endl; // Output: 0\n' +
                            '    return 0;\n' +
                            '}\n' +
                            '```',
                        type: 'code',
                        language: 'cpp',
                        timestamp: '2025-06-02T17:37:11.641237',
                        status: 'unread',
                        priority: 'high'
                    }
                ];
            }

            renderMessages() {
                console.log('Rendering messages count:', this.messages.length);
                const container = document.getElementById('messagesList');
                const countElement = document.getElementById('message-count');

                if (!container || !countElement) {
                    console.error('Required DOM elements not found');
                    this.updateStatus('UI error: Message container not found', 'error');
                    return;
                }

                countElement.textContent = this.messages.length;

                if (this.messages.length === 0) {
                    container.innerHTML = '<div class="loading">No messages found</div>';
                    return;
                }

                // Sort messages by timestamp (newest first)
                const sortedMessages = [...this.messages].sort((a, b) =>
                    new Date(b.timestamp) - new Date(a.timestamp)
                );

                console.log('Sorted messages:', sortedMessages.length);

                const messagesHtml = sortedMessages.map(message => {
                    const isSelected = this.selectedMessage?.id === message.id;
                    return `
                        <div class="message-item ${isSelected ? 'selected' : ''}" 
                             onclick="messageSystem.selectMessage('${message.id}')">
                            <div class="message-header">
                                <div class="message-sender">${this.escapeHtml(message.sender)}</div>
                                <div class="status-indicators">
                                    <div class="status-dot status-${message.status}"></div>
                                    <div class="status-dot priority-${message.priority}"></div>
                                </div>
                            </div>
                            <div class="message-subject">${this.escapeHtml(message.subject)}</div>
                            <div class="message-preview">${this.getPreview(message.content)}</div>
                            <div class="message-time">${this.formatTime(message.timestamp)}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = messagesHtml;
                console.log('Messages rendered successfully');
            }

            selectMessage(messageId) {
                console.log('Selecting message:', messageId);
                this.selectedMessage = this.messages.find(msg => msg.id === messageId);
                
                if (!this.selectedMessage) {
                    console.error('Message not found:', messageId);
                    return;
                }

                this.renderMessages();
                this.renderMessageContent();
                
                if (this.selectedMessage.status === 'unread') {
                    this.selectedMessage.status = 'read';
                    this.markMessageAsRead(messageId);
                }
            }

            renderMessageContent() {
                const container = document.getElementById('messageContent');
                
                if (!container) {
                    console.error('Message content container not found');
                    return;
                }

                if (!this.selectedMessage) {
                    container.innerHTML = '<div class="placeholder">Select a message to view its content</div>';
                    return;
                }

                const msg = this.selectedMessage;
                const processedContent = this.processContent(msg.content || '', msg.type || 'text', msg.language || 'text');

                container.innerHTML = `
                    <div class="content-header">
                        <div class="content-field">
                            <div class="content-label">From:</div>
                            <div class="content-value">${this.escapeHtml(msg.sender || 'Unknown')} <${this.escapeHtml(msg.email || 'no-email')}></div>
                        </div>
                        <div class="content-field">
                            <div class="content-label">Subject:</div>
                            <div class="content-value">${this.escapeHtml(msg.subject || 'No Subject')}</div>
                        </div>
                        <div class="content-field">
                            <div class="content-label">Received:</div>
                            <div class="content-value">${this.formatTime(msg.timestamp)}</div>
                        </div>
                        <div class="content-field">
                            <div class="content-label">Priority:</div>
                            <div class="content-value" style="color: ${this.getPriorityColor(msg.priority || 'medium')}">${(msg.priority || 'medium').toUpperCase()}</div>
                        </div>
                        <div class="content-field">
                            <div class="content-label">Type:</div>
                            <div class="content-value">${(msg.type || 'text').toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="message-body">
                        ${processedContent}
                    </div>
                `;

                // Highlight code after rendering
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            }

            processContent(content, messageType, language) {
                if (!content) return '<div class="text-content">No content available</div>';

                // Handle code blocks based on type and language
                const codeBlockRegex = /```(\w+)?\n?([\s\S]*?)```/g;
                let processedContent = '';
                let lastIndex = 0;
                let match;
                let hasCodeBlocks = false;

                while ((match = codeBlockRegex.exec(content)) !== null) {
                    hasCodeBlocks = true;
                    
                    // Add text before the code block
                    if (match.index > lastIndex) {
                        const textSegment = content.substring(lastIndex, match.index);
                        if (textSegment.trim()) {
                            const escapedText = this.escapeHtml(textSegment);
                            processedContent += `<div class="text-content">${escapedText.replace(/\n/g, '<br>')}</div>`;
                        }
                    }
                    
                    // Process the code block
                    const codeLanguage = match[1] || language || 'text';
                    const code = match[2];
                    const codeId = 'code_' + Math.random().toString(36).substr(2, 9);
                    
                    processedContent += `
                        <div class="code-container">
                            <div class="code-header">
                                <span>${codeLanguage.toUpperCase()} Code</span>
                                <button class="copy-btn" onclick="messageSystem.copyCode('${codeId}')">Copy</button>
                            </div>
                            <pre id="${codeId}"><code class="language-${codeLanguage}">${this.escapeHtml(code)}</code></pre>
                        </div>
                    `;
                    
                    lastIndex = codeBlockRegex.lastIndex;
                }

                // Add any remaining text after the last code block
                if (lastIndex < content.length) {
                    const remainingText = content.substring(lastIndex);
                    if (remainingText.trim()) {
                        const escapedText = this.escapeHtml(remainingText);
                        processedContent += `<div class="text-content">${escapedText.replace(/\n/g, '<br>')}</div>`;
                    }
                }

                // If no code blocks found, treat as plain text or code based on type
                if (!hasCodeBlocks) {
                    const escapedText = this.escapeHtml(content);
                    if (messageType === 'code') {
                        const codeId = 'code_' + Math.random().toString(36).substr(2, 9);
                        processedContent = `
                            <div class="code-container">
                                <div class="code-header">
                                    <span>${language.toUpperCase()} Code</span>
                                    <button class="copy-btn" onclick="messageSystem.copyCode('${codeId}')">Copy</button>
                                </div>
                                <pre id="${codeId}"><code class="language-${language}">${escapedText}</code></pre>
                            </div>
                        `;
                    } else {
                        processedContent = `<div class="text-content">${escapedText.replace(/\n/g, '<br>')}</div>`;
                    }
                }

                return processedContent;
            }

            copyCode(codeId) {
                const codeElement = document.getElementById(codeId);
                if (!codeElement) {
                    console.error('Code element not found:', codeId);
                    return;
                }
                
                const code = codeElement.textContent;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(code).then(() => {
                        this.showNotification('Code copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy code:', err);
                        this.fallbackCopyText(code);
                    });
                } else {
                    this.fallbackCopyText(code);
                }
            }

            fallbackCopyText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showNotification('Code copied to clipboard!');
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    this.showNotification('Failed to copy code');
                }
                document.body.removeChild(textArea);
            }

            async markMessageAsRead(messageId) {
                console.log('Marking message as read:', messageId);
                const message = this.messages.find(m => m.id === messageId);
                if (message && message.status !== 'read') {
                    message.status = 'read';
                    this.renderMessages();
                }
            }

            startAutoRefresh() {
                // Auto-refresh every 10 seconds
                this.refreshInterval = setInterval(() => {
                    console.log('Auto-refreshing messages...');
                    this.loadMessages();
                }, 10000);
            }

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }

            updateStatus(message, type) {
                const statusText = document.getElementById('statusText');
                const statusIndicator = document.getElementById('statusIndicator');
                
                if (statusText) {
                    statusText.textContent = `System Status: ${message}`;
                }
                
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${type}`;
                }
            }

            getPriorityColor(priority) {
                const colors = {
                    'high': 'var(--warning)',
                    'critical': 'var(--error)',
                    'low': 'var(--text-secondary)',
                    'medium': 'var(--success)'
                };
                return colors[priority] || colors['medium'];
            }

            formatTime(timestamp) {
                if (!timestamp) return 'Unknown time';
                try {
                    return new Date(timestamp).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' });
                } catch (error) {
                    console.error('Error formatting time:', error);
                    return 'Invalid date';
                }
            }

            getPreview(content) {
                if (!content) return 'No content';
                
                // Remove code blocks for preview
                const text = content.replace(/```[\s\S]*?```/g, '[Code Block]');
                const preview = text.substring(0, 100);
                return preview + (text.length > 100 ? '...' : '');
            }

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showNotification(message) {
                console.log('Notification:', message);
                
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(n => n.remove());
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--success);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 8px;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            // Public methods for button actions
            refresh() {
                console.log('Manual refresh triggered');
                this.loadMessages();
            }

            toggleFilter() {
                this.showNotification('Filter feature coming soon!');
            }

            markAllRead() {
                let unreadCount = 0;
                this.messages.forEach(msg => {
                    if (msg.status === 'unread') {
                        msg.status = 'read';
                        unreadCount++;
                    }
                });
                
                if (unreadCount > 0) {
                    this.renderMessages();
                    this.showNotification(`${unreadCount} messages marked as read`);
                } else {
                    this.showNotification('No unread messages');
                }
            }

            compose() {
                this.showNotification('Compose feature coming soon!');
            }
        }

        // Global functions for button actions
        function refreshMessages() {
            if (window.messageSystem) {
                window.messageSystem.refresh();
            }
        }

        function toggleFilter() {
            if (window.messageSystem) {
                window.messageSystem.toggleFilter();
            }
        }

        function markAllRead() {
            if (window.messageSystem) {
                window.messageSystem.markAllRead();
            }
        }

        function composeMessage() {
            if (window.messageSystem) {
                window.messageSystem.compose();
            }
        }

        // Initialize the system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing message system...');
            window.messageSystem = new MessageSystem();
        });

        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState !== 'loading') {
            console.log('Document already loaded, initializing message system...');
            window.messageSystem = new MessageSystem();
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            .notification {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-weight: 500;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>